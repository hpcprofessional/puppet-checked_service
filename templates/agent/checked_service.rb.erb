# This file provides code that is executed when the checked_service agent
# is given an action of either 'stopall' or 'status'.
#
# For more information on writing MCollective agents, start here:
#   https://docs.puppetlabs.com/mcollective/reference/plugins/ddl.html

module MCollective
  module Agent
    class Checked_service<RPC::Agent

      # Set up the environment we'll need, to run `puppet resource`.
      environment = {"PATH" => "#{ENV['PATH']}<%= if @kernel == 'windows' then ';C:\Program Files\Puppet Labs\Puppet Enterprise\bin' else ':/opt/puppet/bin' end %>" }

      # #
      # This action stops all services that Hiera says we're managing here.
      action "stopall" do

        # Stop each of the services that hiera says is being managed on
        # this node.  This is generated by Puppet from a template.
        # Look in templates/agent/checked_service.rb.erb for details.
<% unless scope.lookupvar("checked_service::checked_services").empty? -%>

        my_output = ''
        my_error  = ''

<% scope.lookupvar("checked_service::checked_services").each_key do |service| -%>
        cmd =  'puppet resource service <%= service %> ensure=stopped'
        reply[:status]  =  run(cmd, :stderr => :error, :stdout => my_output, :chomp => false, :environment => environment)

<% end -%>
<% end -%>
        reply[:message] = my_output

        if my_error == ''
          reply[:error] = 'none'
        else
          reply[:error] = my_error
        end

      end

      # #
      # This action returns the current status of the services listed in Hiera.
      action "status" do
<% unless scope.lookupvar("checked_service::checked_services").empty? -%>

        my_output = ''
        my_error  = ''

<% scope.lookupvar("checked_service::checked_services").each_key do |service| -%>
        cmd =  'puppet resource service <%= service %>'
        reply[:status]  =  run(cmd, :stderr => my_error, :stdout => my_output, :chomp => false, :environment => environment)

<% end -%>
<% end -%>
        reply[:message] = my_output
        if my_error == ''
          reply[:error] = 'none'
        else
          reply[:error] = my_error
        end
      end

    end
  end
end
